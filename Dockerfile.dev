# 开发环境Dockerfile
FROM node:20-alpine

# 清除所有代理环境变量，避免网络问题
ENV http_proxy=""
ENV https_proxy=""
ENV HTTP_PROXY=""
ENV HTTPS_PROXY=""
ENV no_proxy=""
ENV NO_PROXY=""

# 安装必要的系统依赖、时区数据、pnpm和构建工具（用于better-sqlite3）
RUN apk add --no-cache \
    dumb-init \
    git \
    tzdata \
    python3 \
    make \
    g++ \
    gcc \
    musl-dev \
    && ln -sf python3 /usr/bin/python \
    && cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \
    && echo "Asia/Shanghai" > /etc/timezone \
    && npm install -g pnpm@8 \
    && npm config delete proxy \
    && npm config delete https-proxy \
    && npm config delete http-proxy

# 设置工作目录
WORKDIR /app

# 复制依赖文件
COPY package.json pnpm-lock.yaml ./

# 安装所有依赖（包括开发依赖，使用 --no-frozen-lockfile 允许锁文件更新）
RUN pnpm install --no-frozen-lockfile

# 复制源代码
COPY . .

# 创建数据目录并清理缓存
RUN mkdir -p /app/data && \
    pnpm store prune && \
    npm cache clean --force && \
    rm -rf ~/.npm ~/.cache

# 暴露端口
EXPOSE 3000

# 设置环境变量
ENV NODE_ENV=development
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"
ENV TZ=Asia/Shanghai

# 启动开发服务器
ENTRYPOINT ["dumb-init", "--"]
CMD ["pnpm", "dev"]